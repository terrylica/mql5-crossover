---
plan_id: cci-neutrality-indicator
version: 1.3.2
status: blocked
created: 2025-10-28
last_updated: 2025-10-29

# Objective
objective: |
  Implement CCI Neutrality indicator that quantifies "consecutive CCI bounded
  near zero with few ±100 breaches" using audit-compliant patterns. Validate
  calculations via automated historical testing workflow.

# Service Level Objectives
slos:
  availability:
    target: 100%
    metric: Indicator loads without errors in MT5
    actual: 100%
    status: MET
    measurement: CCI_Neutrality_Debug.ex5 compiles with 0 errors

  correctness:
    target: 100%
    metric: All statistical calculations verified via 7 diagnostic checks
    actual: 0%
    status: NOT_MET
    measurement: analyze_cci_debug.py validation suite (not run yet)

  observability:
    target: 100%
    metric: All intermediate calculations exported to CSV for inspection
    actual: 100%
    status: MET
    measurement: 19 columns exported (base, stats, scores, signals, debug sums)

  maintainability:
    target: 100%
    metric: Code follows audit compliance checklist (8 requirements)
    actual: 100%
    status: MET
    measurement: AUDIT_COMPLIANCE.md documents all 8 fixes applied

# Architecture
approach: |
  Use existing validation methodology (5000-bar warmup) with Wine Python automation
  (v3.0.0). Test with historical data (5 seconds) instead of live ticks (20+ hours).
  Reference canonical documentation for all workflows.

# Components
components:
  - name: indicator_implementations
    files:
      - CCI_Neutrality.mq5 (full version with CsvLogger.mqh)
      - CCI_Neutrality_Simple.mq5 (standalone, minimal visual)
      - CCI_Neutrality_Debug.mq5 (CSV output, statistical validation)
    status:
      - full: NOT_COMPILED (20 errors, CsvLogger include issue)
      - simple: COMPILED (0 errors, 16KB)
      - debug: COMPILED (0 errors, 18KB)

  - name: automation_scripts
    location: users/crossover/
    files:
      - generate_test_data.py (Wine Python historical data fetch)
      - run_cci_validation.sh (all-in-one workflow - GUI manual step)
      - run_cci_validation_headless.sh (Strategy Tester automation attempt)
      - analyze_cci_debug.py (7 diagnostic checks)
      - test_cci_automated.py (Strategy Tester alternative)
    status: PARTIAL (headless automation blocked, GUI workflow viable)

  - name: strategy_tester_automation
    location: Program Files/MetaTrader 5/MQL5/Experts/
    files:
      - CCINeutralityTester.mq5 (wrapper EA for indicator testing)
      - CCINeutralityTester.ex5 (compiled, 11KB, 0 errors)
    config:
      - users/crossover/Config/tester_cci_headless.ini
    status: CREATED_BUT_BLOCKED (terminal loads config but tester doesn't start)

  - name: documentation
    location: Program Files/MetaTrader 5/MQL5/Indicators/Custom/Development/CCINeutrality/
    files:
      - README.md (installation, usage, testing, tuning)
      - AUDIT_COMPLIANCE.md (8 requirements validation)
      - VISUAL_SETUP_GUIDE.md (MT5 GUI workflow)
      - DEBUG_WORKFLOW.md (CSV analysis workflow)
      - AUTOMATED_TESTING.md (historical testing workflow)
    references:
      - docs/guides/WINE_PYTHON_EXECUTION.md (v3.0.0)
      - docs/guides/INDICATOR_VALIDATION_METHODOLOGY.md (5000-bar warmup)
      - docs/MT5_REFERENCE_HUB.md (decision trees)
      - docs/guides/MQL5_TO_PYTHON_MIGRATION_GUIDE.md (7-phase workflow)
      - docs/guides/LESSONS_LEARNED_PLAYBOOK.md (8 gotchas)
    status: COMPLETE

  - name: utility_library
    location: Program Files/MetaTrader 5/MQL5/Include/
    files:
      - CsvLogger.mqh (reusable CSV logging, 150 lines)
    status: CREATED (not validated - full version doesn't compile)

# Implementation Findings
findings:
  - timestamp: 2025-10-28T17:13:00
    category: compilation
    details: |
      CCI_Neutrality.mq5 (full version): 20 errors, 3 warnings
      Likely issue: CsvLogger.mqh include path or syntax errors
      Impact: Full version not usable, but debug version provides same functionality

  - timestamp: 2025-10-28T17:16:00
    category: compilation
    details: |
      CCI_Neutrality_Simple.mq5: 0 errors, 0 warnings, 736ms compile time
      Standalone version (no CSV logging) works correctly
      Validates that core algorithm compiles without external dependencies

  - timestamp: 2025-10-28T17:27:00
    category: compilation
    details: |
      CCI_Neutrality_Debug.mq5: 0 errors, 0 warnings, 779ms compile time
      CSV output built-in (no external include needed)
      19 columns: all intermediate calculations exposed for validation

  - timestamp: 2025-10-28T17:30:00
    category: automation
    details: |
      Created historical testing workflow per user request:
      - Uses MT5 cached data (5 seconds vs 20+ hours)
      - References existing docs (WINE_PYTHON_EXECUTION.md,
        INDICATOR_VALIDATION_METHODOLOGY.md, MT5_REFERENCE_HUB.md)
      - 4 automation scripts created
      - All scripts reference canonical documentation sources

  - timestamp: 2025-10-28T17:35:00
    category: documentation
    details: |
      All documentation includes links to canonical sources:
      - AUTOMATED_TESTING.md: 6 primary workflow references
      - DEBUG_WORKFLOW.md: Complete CSV analysis workflow
      - VISUAL_SETUP_GUIDE.md: Step-by-step MT5 GUI
      - README.md: Installation, testing, tuning
      - AUDIT_COMPLIANCE.md: 8 requirements with evidence

  - timestamp: 2025-10-28T18:00:00
    category: validation
    details: |
      Test data generation via Wine Python: SUCCESS
      - Fetched 5000 bars EURUSD M12 (2025-09-01 to 2025-10-29)
      - 4981 valid CCI values (99.6% coverage)
      - CCI range: [-424.07, 564.62]
      - In-channel ratio: 59.4%
      - Output: test_data_EURUSD_M12_5000bars.csv
      - Time: ~5 seconds (vs 20+ hours for live data)

  - timestamp: 2025-10-29T02:00:00
    category: strategy_tester_automation
    details: |
      Wrapper EA for Strategy Tester automation: CREATED
      - CCINeutralityTester.mq5 uses iCustom() to call CCI_Neutrality_Debug
      - Compiles with 0 errors, 0 warnings (11KB .ex5)
      - #property tester_indicator directive added
      - #property tester_everytick_calculate added to indicator
      - EA matches all 12 indicator input parameters
      - Status: COMPILED_BUT_UNTESTED (blocked by tester non-start)

  - timestamp: 2025-10-29T02:00:00
    category: strategy_tester_automation
    details: |
      Tester configuration INI file: CREATED
      - Format: [Tester] section with Expert, Symbol, Period, etc.
      - Based on mql5.com/en/forum/457213 format specification
      - ShutdownTerminal=1 for automation
      - Visual=false for headless operation
      - Date range: 2025.09.01 to 2025.10.29 (matches test data)
      - Status: CREATED_BUT_INEFFECTIVE (terminal loads config, tester doesn't start)

  - timestamp: 2025-10-29T02:06:00
    category: strategy_tester_automation
    severity: BLOCKING
    details: |
      CRITICAL FINDING: MT5 Strategy Tester does NOT auto-start from /config parameter

      Evidence from terminal logs (logs/20251028.log):
      - 18:56:52: "Startup successfully initialized from start config..."
      - 18:56:52: "Terminal launched with C:\users\crossover\Config\tester_cci_headless.ini"
      - 18:56:55+: Loads previous workspace indicators (ZigZag, cc, CCI_Neutrality_Simple)
      - NO tester activity logged (no "Tester: started", "Tester: loading expert", etc.)
      - Same behavior at 19:06:13 with corrected [Tester] section format

      Attempted solutions (both FAILED):
      1. Original format: TestExpert=, TestSymbol=, etc. (no section)
      2. Corrected format: [Tester] section with Expert=, Symbol=, etc.

      Research findings (mql5.com):
      - Forum posts claim /config with [Tester] section should work
      - One user reports "a lot of tests fail, for no apparent reason"
      - May be CrossOver/Wine specific limitation (not Windows MT5)

      Impact: BLOCKS headless validation workflow
      Status: UNRESOLVED (requires alternative approach)

# Current Status
progress:
  completed:
    - Mathematical specification translated to MQL5
    - 8 audit compliance requirements applied
    - 3 indicator versions created (full, simple, debug)
    - 2 versions compiled successfully (simple, debug)
    - 5 documentation files created with canonical references
    - 4 automation scripts created
    - Wine Python historical data fetch workflow
    - CSV analysis script with 7 diagnostic checks
    - Test data generation (5000 bars EURUSD M12, 5 seconds)

  blocked:
    - item: Headless Strategy Tester automation
      reason: MT5 terminal64.exe /config loads INI but doesn't start Strategy Tester
      impact: Critical (blocks automated validation, forces GUI workflow)
      severity: BLOCKING
      details: |
        Attempted approach: Strategy Tester command line automation
        - Created CCINeutralityTester wrapper EA (compiled, 11KB, 0 errors)
        - Created tester_cci_headless.ini with [Tester] section
        - Terminal successfully loads config file
        - BUT: Tester never starts (no tester activity in logs)
        - Terminal just restores previous workspace instead
        Evidence: Terminal logs show "launched with...tester_cci_headless.ini"
                  but NO "Tester: started" or "Tester: loading expert" messages
      root_cause: |
        MT5 /config parameter loads startup configuration but does NOT trigger
        Strategy Tester execution. May be CrossOver/Wine limitation vs Windows MT5.
      research: |
        - mql5.com/en/forum/457213: [Tester] section format confirmed
        - mql5.com/en/forum/361861: Users report "a lot of tests fail"
        - No documented command line parameter to force tester start
      alternatives:
        - GUI workflow (manual indicator attachment) - VIABLE
        - AppleScript/GUI automation - NOT EXPLORED
        - Python MT5 API for indicator testing - NOT VIABLE (no indicator buffer access)
      status: UNRESOLVED (reverting to GUI workflow)

    - item: Validation workflow completion (GUI approach)
      reason: MT5 GUI interaction required (attach indicator to chart)
      impact: Medium (blocks correctness SLO verification, adds manual step)
      details: |
        Step 1 (generate test data): COMPLETE
        Step 2 (attach indicator): REQUIRES USER ACTION (GUI manual step)
        Step 3 (analyze CSV): PENDING (waiting for step 2)
      workaround: User must manually attach CCI_Neutrality_Debug indicator to EURUSD M12 chart

    - item: Full version compilation (CCI_Neutrality.mq5)
      reason: CsvLogger.mqh include errors (20 compilation errors)
      impact: Low (debug version provides same CSV functionality)
      workaround: Use CCI_Neutrality_Debug.mq5 instead

  pending:
    - item: Attach indicator to chart (USER ACTION REQUIRED)
      description: Manual step - MT5 limitation prevents automation
      steps:
        - Open MT5
        - Open EURUSD M12 chart
        - Press Home to load history (~5000 bars)
        - Navigator → Indicators → Custom → Development → CCINeutrality
        - Drag CCI_Neutrality_Debug onto chart
        - Click OK (defaults are fine)
        - Verify Terminal → Journal shows "CSV debug output: MQL5/Files/cci_debug_EURUSD_PERIOD_M12_*.csv"
      dependencies:
        - MT5 running
        - Test data generated (COMPLETE)
      estimated_time: 2 minutes

    - item: Merge to main
      description: Integrate CCI Neutrality indicator into main branch
      dependencies:
        - Validation workflow passes (correctness SLO = 100%)
        - All 7 diagnostic checks show PASS
      estimated_time: 2 minutes

# Next Steps (Prioritized)
next_steps:
  - priority: 1
    action: Run validation workflow using debug version
    rationale: |
      Must verify correctness SLO (currently 0%, target 100%) before merging.
      Debug version has all needed functionality (CSV output built-in).
      Uses existing INDICATOR_VALIDATION_METHODOLOGY.md workflow (5000-bar warmup).
    command: |
      cd /Users/terryli/Library/Application\ Support/CrossOver/Bottles/MetaTrader\ 5/drive_c/users/crossover
      ./run_cci_validation.sh EURUSD M12 5000
    expected_outcome: All 7 diagnostic checks show PASS
    time_estimate: 5 minutes

  - priority: 2
    action: Review validation results and update plan
    rationale: |
      If validation passes, correctness SLO → 100%, ready to merge.
      If validation fails, debug calculations and update implementation.
    dependencies:
      - Step 1 complete
    time_estimate: 2 minutes

  - priority: 3
    action: Merge to main (if validation passes)
    rationale: |
      All SLOs met (availability 100%, correctness 100%, observability 100%,
      maintainability 100%). Indicator ready for production use.
    command: |
      git checkout main
      git merge feature/cci-neutrality-indicator
      git push origin main
    dependencies:
      - Validation workflow passes
      - All 7 diagnostic checks PASS
    time_estimate: 2 minutes

  - priority: 4
    action: Debug full version compilation (optional)
    rationale: |
      Low priority - debug version provides same CSV functionality.
      Only needed if want to use CsvLogger.mqh for other indicators.
    dependencies:
      - Steps 1-3 complete
    time_estimate: 30 minutes

# References
documentation:
  canonical_workflows:
    - docs/guides/WINE_PYTHON_EXECUTION.md (v3.0.0 Wine Python headless)
    - docs/guides/INDICATOR_VALIDATION_METHODOLOGY.md (5000-bar warmup)
    - docs/MT5_REFERENCE_HUB.md (decision trees, automation matrix)
    - docs/guides/MQL5_TO_PYTHON_MIGRATION_GUIDE.md (7-phase workflow)
    - docs/guides/LESSONS_LEARNED_PLAYBOOK.md (8 critical gotchas)

  indicator_docs:
    - Program Files/MetaTrader 5/MQL5/Indicators/Custom/Development/CCINeutrality/README.md
    - Program Files/MetaTrader 5/MQL5/Indicators/Custom/Development/CCINeutrality/AUTOMATED_TESTING.md
    - Program Files/MetaTrader 5/MQL5/Indicators/Custom/Development/CCINeutrality/DEBUG_WORKFLOW.md
    - Program Files/MetaTrader 5/MQL5/Indicators/Custom/Development/CCINeutrality/AUDIT_COMPLIANCE.md

  automation_scripts:
    - users/crossover/run_cci_validation.sh (all-in-one workflow)
    - users/crossover/generate_test_data.py (Wine Python data fetch)
    - users/crossover/analyze_cci_debug.py (7 diagnostic checks)

# Changelog
changes:
  - version: 1.3.2
    date: 2025-10-29
    description: CSV export working via workspace restoration, calculation errors identified
    changes:
      - User attached CCI_Neutrality_Debug to EURUSD M12 chart and saved workspace
      - Workspace restoration during startup triggers indicator initialization and CSV export
      - CSV generated successfully (100,438 bars, 10MB, 19 columns)
      - Ran automated analysis using uv (per global CLAUDE.md Python requirements)
      - Analysis revealed critical calculation failures (4/4 diagnostic checks FAILED)
      - Root cause identified - insufficient CCI warmup period before rolling window priming
      - CCI indicator needs 20 bars warmup, but code accumulates bars 0-29 without checking for EMPTY_VALUE
      - Accumulating EMPTY_VALUE/inf from early CCI bars causes inf in sum_cci, sum_cci2, sum_excess
      - Propagates to all derived statistics - mu=inf, variance=-nan, sd=-nan, e=inf
      - Score components become invalid - v=-nan, score=-nan
      - NO coil/expansion signals triggered in 100K bars due to invalid scores
    slos:
      availability: 100%
      correctness: 0% (CSV generated but calculations produce inf/nan, all diagnostics FAILED)
      observability: 100%
      maintainability: 100%
    blocking_issue: |
      Indicator implementation has fundamental calculation error - insufficient warmup handling.
      Code primes rolling window starting at bar 29 (InpWindow-1) but CCI indicator (InpCCILength=20)
      produces EMPTY_VALUE/inf for bars 0-19. These invalid values accumulate into sum_cci/sum_cci2/sum_excess
      causing inf propagation through all statistical calculations (mu, variance, sd, e, v, score).

      Fix required - line 232 priming loop must skip bars where CCI is not yet valid:
      - Check BarsCalculated(hCCI) to determine first valid CCI bar
      - Start priming from max(0, start - InpWindow + 1, first_valid_cci_bar)
      - OR check for EMPTY_VALUE/inf before accumulating into sums

      This is an indicator implementation bug, not an automation/workflow issue.

  - version: 1.3.1
    date: 2025-10-29
    description: Script automation works but indicator loading via iCustom() fails with error 4806
    changes:
      - Fixed indicator path in CCI_Export_Script.mq5 (removed ::Indicators\ prefix and .ex5 extension)
      - Recompiled CCI_Export_Script.ex5 successfully (19:42, 0 errors, 734ms)
      - Confirmed workspace prerequisite (EURUSD M12 chart open) enables script execution
      - Script executes successfully via [StartUp] section
      - Indicator handle creates successfully (ID 10)
      - BarsCalculated() returns error 4806 (ERR_INDICATOR_DATA_NOT_FOUND)
      - NO indicator log messages (OnInit() never executed or failed silently)
      - Hypothesis: File I/O or initialization requirements prevent indicator from working in iCustom() context
      - Indicator works when attached to chart via GUI (proven at 17:34 on EURUSD M10)
      - Updated MT5_AUTOMATION_BLOCKING_ISSUE_v1.3.0.md with v1.3.0 Update section
    slos:
      availability: 100%
      correctness: 0% (blocked on indicator initialization failure in iCustom() context)
      observability: 100%
      maintainability: 100%
    blocking_issue: |
      [StartUp] script automation executes successfully, but CCI_Neutrality_Debug indicator
      fails to initialize when loaded via iCustom() from script (error 4806).
      Indicator works in GUI mode (chart attachment) but not in programmatic context.
      Possible file I/O permission restrictions or missing chart context.
      Three viable alternatives: (1) Manual GUI workflow, (2) v3.0.0 Python API + Python
      indicator, (3) Investigate indicator initialization with minimal test case.

  - version: 1.2.0
    date: 2025-10-29
    description: Strategy Tester automation attempted, blocked by terminal non-start issue
    changes:
      - Created CCINeutralityTester wrapper EA (iCustom pattern, 11KB, 0 errors)
      - Created tester_cci_headless.ini ([Tester] section format)
      - Created run_cci_validation_headless.sh automation script
      - Added #property tester_everytick_calculate to indicator
      - Attempted terminal64.exe /config automation (2 iterations)
      - Diagnosed critical blocking issue (terminal loads INI but tester doesn't start)
      - Researched mql5.com forums (confirmed [Tester] format, found reliability issues)
      - Analyzed terminal logs (no tester activity, workspace restore only)
      - Updated plan status remains "blocked"
      - Documented 3 new findings in plan (EA, INI, blocking issue)
    slos:
      availability: 100%
      correctness: 0% (blocked on tester non-start, cannot validate)
      observability: 100%
      maintainability: 100%
    blocking_issue: |
      MT5 Strategy Tester does NOT auto-start from /config parameter on CrossOver/Wine.
      Terminal loads config successfully but restores workspace instead of starting tester.
      No documented command line parameter to force tester execution.
      Reverting to GUI workflow (manual indicator attachment required).

  - version: 1.1.0
    date: 2025-10-28
    description: Test data generation complete, blocked on GUI interaction
    changes:
      - Generated 5000 bars historical test data via Wine Python
      - Validated data quality (4981 valid CCI values, 99.6% coverage)
      - Identified blocking issue (MT5 GUI required for indicator attachment)
      - Updated plan status to "blocked"
      - Documented user action required (attach indicator manually)
    slos:
      availability: 100%
      correctness: 0% (blocked on GUI step, cannot validate)
      observability: 100%
      maintainability: 100%
    blocking_issue: MT5 does not support headless indicator attachment

  - version: 1.0.0
    date: 2025-10-28
    description: Initial plan creation
    changes:
      - Created CCI Neutrality indicator (3 versions)
      - Applied 8 audit compliance requirements
      - Created 5 documentation files
      - Created 4 automation scripts
      - Compiled simple and debug versions (0 errors)
      - Identified full version compilation issue (20 errors)
      - Created historical testing workflow (5 sec vs 20+ hours)
    slos:
      availability: 100%
      correctness: 0% (not validated yet)
      observability: 100%
      maintainability: 100%
